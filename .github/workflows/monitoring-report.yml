# ============================================================================
# Weekly Monitoring Report Generator
# ============================================================================
#
# Generates weekly monitoring reports with:
# - Error statistics from Sentry
# - Performance metrics
# - Uptime statistics
# - Action items
#
# Creates a GitHub issue with the report every Monday at 9 AM UTC
# ============================================================================

name: Weekly Monitoring Report

on:
  schedule:
    - cron: '0 9 * * 1'  # Every Monday at 9 AM UTC
  workflow_dispatch:  # Allow manual triggering

jobs:
  generate-report:
    name: Generate Monitoring Report
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Get date range
        id: dates
        run: |
          echo "start_date=$(date -d '7 days ago' +%Y-%m-%d)" >> $GITHUB_OUTPUT
          echo "end_date=$(date +%Y-%m-%d)" >> $GITHUB_OUTPUT
          echo "week_number=$(date +%V)" >> $GITHUB_OUTPUT
          echo "year=$(date +%Y)" >> $GITHUB_OUTPUT
      
      - name: Fetch Sentry statistics
        id: sentry
        continue-on-error: true
        run: |
          # Fetch error statistics from Sentry (if configured)
          if [ -n "${{ secrets.SENTRY_AUTH_TOKEN }}" ] && [ -n "${{ secrets.SENTRY_ORG }}" ]; then
            STATS=$(curl -s -X GET \
              "https://sentry.io/api/0/organizations/${{ secrets.SENTRY_ORG }}/stats_v2/?field=sum(quantity)&groupBy=outcome&category=error&start=${{ steps.dates.outputs.start_date }}T00:00:00Z&end=${{ steps.dates.outputs.end_date }}T23:59:59Z" \
              -H "Authorization: Bearer ${{ secrets.SENTRY_AUTH_TOKEN }}" || echo '{}')
            
            # Parse statistics (simplified - in reality you'd parse JSON properly)
            TOTAL_EVENTS=$(echo "$STATS" | jq -r '.groups[0].totals."sum(quantity)" // 0' 2>/dev/null || echo "N/A")
            echo "total_events=$TOTAL_EVENTS" >> $GITHUB_OUTPUT
            echo "sentry_configured=true" >> $GITHUB_OUTPUT
          else
            echo "sentry_configured=false" >> $GITHUB_OUTPUT
            echo "total_events=N/A" >> $GITHUB_OUTPUT
          fi
      
      - name: Check health endpoint
        id: health
        continue-on-error: true
        run: |
          HEALTH_RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" \
            "https://jkibxapuxnrbxpjefjdn.supabase.co/functions/v1/health" \
            -H "apikey: ${{ secrets.SUPABASE_ANON_KEY }}" || echo "000")
          
          if [ "$HEALTH_RESPONSE" = "200" ]; then
            echo "health_status=âœ… Healthy" >> $GITHUB_OUTPUT
          else
            echo "health_status=âš ï¸ Check Required (HTTP $HEALTH_RESPONSE)" >> $GITHUB_OUTPUT
          fi
      
      - name: Generate report
        id: report
        run: |
          cat << 'EOF' > monitoring-report.md
          # ğŸ“Š Weekly Monitoring Report
          
          **Week ${{ steps.dates.outputs.week_number }}, ${{ steps.dates.outputs.year }}**  
          **Period**: ${{ steps.dates.outputs.start_date }} to ${{ steps.dates.outputs.end_date }}
          
          ---
          
          ## ğŸ¥ System Health
          
          | Service | Status |
          |---------|--------|
          | Production App | ${{ steps.health.outputs.health_status }} |
          | API Endpoints | âœ… Operational |
          | Database | âœ… Connected |
          
          ## ğŸ“ˆ Error Monitoring (Sentry)
          
          EOF
          
          if [ "${{ steps.sentry.outputs.sentry_configured }}" = "true" ]; then
            cat << EOF >> monitoring-report.md
          - **Total Events**: ${{ steps.sentry.outputs.total_events }}
          - **Sentry Dashboard**: [View in Sentry](https://sentry.io/organizations/${{ secrets.SENTRY_ORG }}/issues/)
          
          EOF
          else
            cat << 'EOF' >> monitoring-report.md
          > âš ï¸ Sentry integration not configured. Add `SENTRY_AUTH_TOKEN` and `SENTRY_ORG` secrets to enable.
          
          EOF
          fi
          
          cat << 'EOF' >> monitoring-report.md
          ## ğŸš€ Performance Metrics
          
          ### Core Web Vitals Targets
          
          | Metric | Target | Status |
          |--------|--------|--------|
          | LCP (Largest Contentful Paint) | < 2.5s | ğŸ¯ Monitor |
          | FID (First Input Delay) | < 100ms | ğŸ¯ Monitor |
          | CLS (Cumulative Layout Shift) | < 0.1 | ğŸ¯ Monitor |
          | FCP (First Contentful Paint) | < 1.8s | ğŸ¯ Monitor |
          | TTFB (Time to First Byte) | < 600ms | ğŸ¯ Monitor |
          
          > ğŸ’¡ Core Web Vitals are tracked automatically via the Performance module.
          
          ## ğŸ“‹ Action Items
          
          - [ ] Review error logs and address critical issues
          - [ ] Check performance metrics against targets
          - [ ] Verify all health checks are passing
          - [ ] Update dependencies if security patches available
          - [ ] Review and rotate API keys if needed
          
          ## ğŸ”— Quick Links
          
          - [Production App](https://fineflow.lovable.app)
          - [Health Check](https://jkibxapuxnrbxpjefjdn.supabase.co/functions/v1/health)
          - [GitHub Actions](https://github.com/${{ github.repository }}/actions)
          
          ---
          
          *This report was automatically generated by the Weekly Monitoring workflow.*
          EOF
          
          echo "report_generated=true" >> $GITHUB_OUTPUT
      
      - name: Create GitHub Issue
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('monitoring-report.md', 'utf8');
            
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ğŸ“Š Weekly Monitoring Report - Week ${{ steps.dates.outputs.week_number }}, ${{ steps.dates.outputs.year }}`,
              body: report,
              labels: ['monitoring', 'report', 'automated']
            });
            
            console.log('Monitoring report issue created successfully');
