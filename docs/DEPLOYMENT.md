# FineFlow Deployment Guide

## Table of Contents

1. [Prerequisites](#prerequisites)
2. [Environment Variables](#environment-variables)
3. [Local Development](#local-development)
4. [Production Deployment](#production-deployment)
5. [Edge Functions](#edge-functions)
6. [Database Migrations](#database-migrations)
7. [Post-Deployment Checklist](#post-deployment-checklist)
8. [Monitoring & Logging](#monitoring--logging)

---

## Prerequisites

### Required Tools

| Tool | Version | Purpose |
|------|---------|---------|
| Node.js | 18+ | JavaScript runtime |
| npm/pnpm/bun | Latest | Package manager |
| Git | Latest | Version control |

### Accounts

| Service | Purpose | Required |
|---------|---------|----------|
| Lovable | Hosting & backend | Yes |
| OpenAI | Embeddings & fine-tuning | Optional (user-provided) |

---

## Environment Variables

### Frontend (.env)

```env
# Supabase Configuration (auto-generated by Lovable Cloud)
VITE_SUPABASE_URL=https://your-project.supabase.co
VITE_SUPABASE_PUBLISHABLE_KEY=eyJhbGciOiJIUzI1NiIs...
VITE_SUPABASE_PROJECT_ID=your-project-id

# Optional: API URL for custom backend
VITE_API_URL=https://api.example.com
```

### Edge Functions (Supabase Secrets)

| Secret | Description | Example |
|--------|-------------|---------|
| `SUPABASE_URL` | Project URL | `https://xxx.supabase.co` |
| `SUPABASE_ANON_KEY` | Anonymous/public key | `eyJhbGci...` |
| `SUPABASE_SERVICE_ROLE_KEY` | Admin key (never expose) | `eyJhbGci...` |
| `LOVABLE_API_KEY` | AI Gateway access | `lvbl_...` |
| `API_KEY_ENCRYPTION_SECRET` | User API key encryption | Random 32-char string |
| `OPENAI_API_KEY` | System embeddings (optional) | `sk-...` |

### Setting Secrets

Secrets are managed through Lovable Cloud:

1. Navigate to your project settings
2. Go to "Secrets" section
3. Add or update secret values

---

## Local Development

### Initial Setup

```bash
# Clone the repository
git clone <repository-url>
cd fineflow

# Install dependencies
npm install

# Start development server
npm run dev
```

### Development Server

The app runs at `http://localhost:8080` (or the port shown in terminal).

### Available Scripts

```bash
# Development
npm run dev          # Start dev server with hot reload

# Building
npm run build        # Production build
npm run preview      # Preview production build

# Testing
npm run test         # Run tests
npm run test:ui      # Run tests with UI
npm run typecheck    # TypeScript type checking

# Linting
npm run lint         # Run ESLint
```

### Local Edge Functions

Edge functions are automatically deployed when using Lovable Cloud. For local testing:

1. Functions run in Deno runtime
2. Use Lovable Cloud's edge function logs for debugging
3. Test via the preview environment

---

## Production Deployment

### Lovable Deployment (Recommended)

1. **Open your project** in Lovable
2. **Click "Publish"** in the top right
3. **Configure domain** (optional custom domain)
4. **Click "Publish"**

Lovable automatically:
- Builds the React application
- Deploys to CDN
- Configures SSL certificates
- Deploys edge functions
- Applies database migrations

### Custom Domain Setup

1. Go to Project Settings → Domains
2. Add your custom domain
3. Configure DNS:
   - CNAME: `your-domain.com` → `<project>.lovable.app`
4. Wait for SSL provisioning (automatic)

### Environment-Specific Builds

```bash
# Production build
npm run build

# Output in dist/
```

---

## Edge Functions

### Deployment

Edge functions in `supabase/functions/` are automatically deployed with the project.

### Function Structure

```
supabase/functions/
├── _shared/           # Shared utilities (not deployed individually)
│   ├── pipeline-types.ts
│   ├── artifact-registry.ts
│   └── ...
├── process-document/  # Each folder = one function
│   └── index.ts
├── semantic-search/
│   └── index.ts
└── ...
```

### Function Configuration

Configuration is in `supabase/config.toml`:

```toml
[functions.process-document]
verify_jwt = false  # Custom JWT handling in function

[functions.health]
verify_jwt = false  # Public health check
```

### Viewing Logs

1. Open Lovable Cloud backend
2. Navigate to "Logs" section
3. Filter by function name

---

## Database Migrations

### How Migrations Work

1. Migrations are stored in `supabase/migrations/`
2. Named with timestamp prefix: `YYYYMMDDHHMMSS_description.sql`
3. Applied automatically during deployment

### Creating a Migration

Migrations are typically created through Lovable's database tools:

1. Request database changes via chat
2. Lovable creates migration file
3. Review and approve
4. Migration applies on next deployment

### Migration Best Practices

```sql
-- Good: Incremental, reversible
ALTER TABLE documents ADD COLUMN new_field text;

-- Good: Include defaults for existing data
ALTER TABLE documents ADD COLUMN status text NOT NULL DEFAULT 'uploaded';

-- Good: Use IF NOT EXISTS for idempotency
CREATE TABLE IF NOT EXISTS new_table (...);

-- Avoid: Data-dependent constraints
-- CHECK (created_at > '2024-01-01') -- Will fail on restore
```

---

## Post-Deployment Checklist

### Functional Verification

- [ ] **Authentication**: Login and signup work
- [ ] **Document Upload**: Files upload to storage
- [ ] **Document Processing**: 6-stage pipeline completes
- [ ] **Search**: Semantic and full-text search return results
- [ ] **Training Data**: Q&A generation works
- [ ] **Notifications**: Toast notifications appear
- [ ] **Admin Dashboard**: Admin features accessible (admin users)

### Security Verification

- [ ] **RLS Policies**: Users can only see their own data
- [ ] **Storage Policies**: Users can only access their own files
- [ ] **Admin Routes**: Non-admins redirected from /admin
- [ ] **Edge Functions**: Require authentication where expected
- [ ] **Quota Enforcement**: Limits enforced correctly

### Performance Verification

- [ ] **Page Load**: Dashboard loads in <3 seconds
- [ ] **Search Response**: Results in <2 seconds
- [ ] **File Upload**: <30 seconds for 10MB file
- [ ] **API Response**: Edge functions respond <500ms

### Monitoring Setup

- [ ] **Error Tracking**: Console errors monitored
- [ ] **Edge Function Logs**: Accessible and retained
- [ ] **Database Performance**: Query times acceptable
- [ ] **Storage Usage**: Within quota limits

---

## Monitoring & Logging

### Edge Function Logs

Access logs through Lovable Cloud:

1. Open Backend panel
2. Navigate to Edge Functions
3. View logs by function

Log format:
```
[2024-01-15T10:00:00Z] [process-document] Stage ingestion: STARTED
[2024-01-15T10:00:01Z] [process-document] Stage ingestion: COMPLETED in 150ms
```

### Database Logs

Query Supabase analytics:

```sql
-- Recent database errors
SELECT timestamp, event_message, parsed.error_severity 
FROM postgres_logs
CROSS JOIN unnest(metadata) as m
CROSS JOIN unnest(m.parsed) as parsed
ORDER BY timestamp DESC
LIMIT 100;

-- Auth events
SELECT timestamp, event_message, metadata.status, metadata.path
FROM auth_logs
CROSS JOIN unnest(metadata) as metadata
ORDER BY timestamp DESC
LIMIT 100;
```

### Application-Level Logging

```typescript
// Frontend logging (console)
console.log('[DocumentService] Uploading file:', filename);
console.error('[DocumentService] Upload failed:', error);

// Edge function logging
console.log(`[Orchestrator:v5] Request ${requestId} started`);
console.error(`[Orchestrator:v5] Stage ${stage}: FAILED - ${error}`);
```

### Audit Logs

```sql
-- Recent user actions
SELECT 
  user_name, 
  action, 
  resource_type, 
  resource_name,
  created_at
FROM audit_logs
ORDER BY created_at DESC
LIMIT 50;
```

### Health Monitoring

```bash
# Check system health
curl https://your-project.supabase.co/functions/v1/health

# Expected response
{"status": "ok", "timestamp": "2024-01-15T10:00:00Z"}
```

### Performance Metrics

Access via admin dashboard:

- Processing throughput (documents/hour)
- Average processing time
- Error rates by stage
- Active users
- Storage usage
- API call volume

---

## Troubleshooting

### Common Issues

| Issue | Cause | Solution |
|-------|-------|----------|
| "Unauthorized" errors | Expired JWT | Clear localStorage, re-login |
| Processing stuck | Edge function timeout | Resume from failed stage |
| Search returns no results | Embeddings not generated | Check document status = "ready" |
| File upload fails | Storage quota exceeded | Upgrade plan or delete files |
| Admin features hidden | User not admin | Update profile.role to 'admin' |

### Debug Mode

```typescript
// Enable verbose logging
localStorage.setItem('debug', 'true');

// Check auth state
console.log(await supabase.auth.getSession());

// Check quota
console.log(await supabase.rpc('get_quota_status', { _user_id: userId }));
```

---

## Related Documentation

- [ARCHITECTURE.md](./ARCHITECTURE.md) - System architecture
- [SECURITY.md](./SECURITY.md) - Security configuration
- [DEVELOPER_GUIDE.md](./DEVELOPER_GUIDE.md) - Development setup
